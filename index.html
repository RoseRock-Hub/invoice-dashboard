<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Rose Rock — Invoice Dashboard</title>
<script src="https://alcdn.msauth.net/browser/2.35.0/js/msal-browser.min.js"></script>
<link href="https://fonts.googleapis.com/css2?family=DM+Sans:opsz,wght@9..40,300;9..40,400;9..40,500;9..40,600;9..40,700&family=JetBrains+Mono:wght@400;500&display=swap" rel="stylesheet">
<style>
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body { font-family: 'DM Sans', 'Helvetica Neue', sans-serif; background: #f8f9fb; color: #1a1d25; }
  ::-webkit-scrollbar { width: 6px; height: 6px; }
  ::-webkit-scrollbar-track { background: #f0f1f3; }
  ::-webkit-scrollbar-thumb { background: #c8cbd3; border-radius: 3px; }
  ::selection { background: #c2956a44; }

  #auth-overlay {
    position: fixed; inset: 0; background: #f8f9fb;
    display: flex; align-items: center; justify-content: center;
    z-index: 9999; flex-direction: column; gap: 20px;
  }
  #auth-overlay.hidden { display: none; }
  #auth-overlay .logo {
    width: 56px; height: 56px; border-radius: 14px;
    background: linear-gradient(135deg, #c2956a, #8b6539);
    display: flex; align-items: center; justify-content: center;
    font-size: 28px; font-weight: 700; color: #fff;
  }
  #auth-overlay h2 { font-size: 18px; font-weight: 600; color: #1a1d25; }
  #auth-overlay p { font-size: 13px; color: #8b8f9c; max-width: 320px; text-align: center; }
  #sign-in-btn {
    padding: 12px 32px; border-radius: 10px; font-size: 14px; font-weight: 600;
    border: none; cursor: pointer; font-family: inherit;
    background: linear-gradient(135deg, #c2956a, #a07848); color: #fff;
    transition: transform 0.15s, box-shadow 0.15s;
  }
  #sign-in-btn:hover { transform: translateY(-1px); box-shadow: 0 4px 16px rgba(194,149,106,0.35); }
  #auth-error { color: #991b1b; font-size: 12px; display: none; }

  header {
    padding: 20px 32px; border-bottom: 1px solid #e5e7eb;
    display: flex; align-items: center; justify-content: space-between;
    background: #ffffff; position: sticky; top: 0; z-index: 100;
    box-shadow: 0 1px 3px rgba(0,0,0,0.04);
  }
  .header-left { display: flex; align-items: center; gap: 16px; }
  .header-logo {
    width: 36px; height: 36px; border-radius: 8px;
    background: linear-gradient(135deg, #c2956a, #8b6539);
    display: flex; align-items: center; justify-content: center;
    font-size: 18px; font-weight: 700; color: #fff;
  }
  .header-title { font-size: 16px; font-weight: 600; letter-spacing: -0.01em; }
  .header-sub { font-size: 12px; color: #8b8f9c; margin-top: 1px; }
  .header-right { display: flex; align-items: center; gap: 16px; }
  .new-badge {
    background: #c2956a; color: #fff; padding: 4px 12px;
    border-radius: 999px; font-size: 12px; font-weight: 600;
    animation: pulse 2s infinite; display: none;
  }
  @keyframes pulse { 0%, 100% { opacity: 1; } 50% { opacity: 0.7; } }
  .last-update { font-size: 11px; color: #9ca0ac; font-family: 'JetBrains Mono', monospace; }
  .refresh-btn {
    background: #f0f1f3; border: 1px solid #e5e7eb; border-radius: 8px;
    color: #5a5f6d; padding: 6px 14px; font-size: 12px; font-weight: 500;
    cursor: pointer; font-family: inherit; transition: all 0.15s;
  }
  .refresh-btn:hover { background: #e5e7eb; color: #1a1d25; }
  .user-info { font-size: 11px; color: #8b8f9c; }

  #status-bar {
    padding: 10px 32px; font-size: 13px; font-weight: 500;
    border-bottom: 1px solid #e5e7eb; display: none;
  }
  #status-bar.success { display: block; background: #ecfdf5; color: #065f46; }
  #status-bar.error { display: block; background: #fef2f2; color: #991b1b; }
  #status-bar.loading { display: block; background: #f8f9fb; color: #5a5f6d; }

  .toolbar {
    padding: 16px 32px; display: flex; align-items: center; justify-content: space-between;
    border-bottom: 1px solid #e5e7eb; background: #ffffff;
  }
  .tabs { display: flex; gap: 4px; }
  .tab-btn {
    padding: 6px 14px; border-radius: 6px; font-size: 12px; font-weight: 500;
    border: none; cursor: pointer; font-family: inherit;
    background: transparent; color: #8b8f9c; transition: all 0.15s;
  }
  .tab-btn.active { background: #c2956a15; color: #8b6539; }
  .tab-count {
    margin-left: 4px; font-size: 10px; font-weight: 600;
    background: #f0f1f3; padding: 1px 6px; border-radius: 999px; color: #8b8f9c;
  }
  .tab-btn.active .tab-count { background: #c2956a22; color: #8b6539; }
  .actions { display: flex; gap: 8px; }
  .btn-create {
    padding: 7px 16px; border-radius: 8px; font-size: 12px; font-weight: 600;
    border: none; cursor: pointer; font-family: inherit;
    background: linear-gradient(135deg, #c2956a, #a07848); color: #fff;
  }
  .btn-create:disabled { opacity: 0.5; cursor: not-allowed; }

  .table-wrap { padding: 0 32px 80px; overflow-x: auto; }
  table { width: 100%; border-collapse: collapse; margin-top: 8px; }
  th {
    padding: 10px 12px; text-align: left; font-size: 11px; font-weight: 600;
    color: #8b8f9c; text-transform: uppercase; letter-spacing: 0.05em;
    white-space: nowrap; background: #fafbfc;
  }
  th.right { text-align: right; }
  td { padding: 12px 12px; font-size: 13px; white-space: nowrap; }
  tr.data-row { border-bottom: 1px solid #f0f1f3; background: #ffffff; cursor: pointer; transition: background 0.1s; }
  tr.data-row:hover { background: #fafbfc; }
  tr.data-row.selected { background: #c2956a08; }
  .cell-job { font-family: 'JetBrains Mono', monospace; font-size: 12px; font-weight: 500; color: #8b6539; }
  .cell-client { font-weight: 500; color: #1a1d25; }
  .cell-address { font-size: 12px; color: #6b7080; max-width: 200px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .cell-desc { font-size: 12px; color: #6b7080; max-width: 280px; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }
  .cell-amount { text-align: right; font-family: 'JetBrains Mono', monospace; font-size: 13px; font-weight: 500; color: #1a1d25; }
  .cell-date { font-size: 12px; color: #6b7080; }
  .cell-po { font-size: 12px; color: #6b7080; font-family: 'JetBrains Mono', monospace; }
  .cell-invoice { font-family: 'JetBrains Mono', monospace; font-size: 12px; color: #2563eb; }
  .empty-row td { padding: 48px; text-align: center; color: #8b8f9c; font-size: 13px; font-style: italic; }

  .badge {
    display: inline-block; padding: 2px 10px; border-radius: 999px; font-size: 11px;
    font-weight: 600; letter-spacing: 0.02em; text-transform: uppercase;
  }
  .badge-ready { background: #fef3c7; color: #92400e; border: 1px solid #fcd34d; }
  .badge-invoiced { background: #d1fae5; color: #065f46; border: 1px solid #6ee7b7; }
  .badge-error { background: #fef2f2; color: #991b1b; border: 1px solid #fca5a5; }

  .cell-select {
    background: #ffffff; border: 1px solid #e5e7eb; border-radius: 6px;
    color: #1a1d25; padding: 4px 8px; font-size: 11px; font-family: inherit;
    cursor: pointer; max-width: 180px; width: 100%;
  }
  .cell-select.empty { color: #8b8f9c; }
  input[type="checkbox"] { accent-color: #c2956a; cursor: pointer; }

  .summary-bar {
    position: fixed; bottom: 0; left: 0; right: 0;
    padding: 12px 32px; background: #ffffff; border-top: 1px solid #e5e7eb;
    display: flex; align-items: center; justify-content: space-between;
    font-size: 12px; color: #8b8f9c; box-shadow: 0 -1px 3px rgba(0,0,0,0.04);
  }
  .summary-bar .total { color: #1a1d25; font-family: 'JetBrains Mono', monospace; font-weight: 500; }
  .summary-bar .sel-count { color: #8b6539; }
  .summary-bar .auto-refresh { color: #059669; }
</style>
</head>
<body>

<!-- AUTH OVERLAY -->
<div id="auth-overlay">
  <div class="logo">R</div>
  <h2>Rose Rock Invoice Dashboard</h2>
  <p>Sign in with your Microsoft account to access the Field Services job list.</p>
  <button id="sign-in-btn" onclick="signIn()">Sign in with Microsoft</button>
  <div id="auth-error"></div>
</div>

<!-- MAIN APP -->
<div id="app" style="display:none; min-height:100vh;">
  <header>
    <div class="header-left">
      <div class="header-logo">R</div>
      <div>
        <div class="header-title">Rose Rock Environmental</div>
        <div class="header-sub">Field Services — Invoice Dashboard</div>
      </div>
    </div>
    <div class="header-right">
      <div class="new-badge" id="new-badge"></div>
      <div class="last-update" id="last-update">Loading...</div>
      <button class="refresh-btn" onclick="refreshData()">↻ Refresh</button>
      <div class="user-info" id="user-info"></div>
    </div>
  </header>
  <div id="status-bar"></div>
  <div class="toolbar">
    <div class="tabs" id="tabs"></div>
    <div class="actions" id="actions"></div>
  </div>
  <div class="table-wrap">
    <table>
      <thead id="table-head"></thead>
      <tbody id="table-body"></tbody>
    </table>
  </div>
  <div class="summary-bar">
    <div id="summary-left"></div>
    <div id="summary-right"></div>
  </div>
</div>

<script>
// ============================================================
// CONFIG — Only columns R (Ready to Invoice) and S (Invoice Number)
// ============================================================
const CONFIG = {
  auth: {
    clientId: "67ec2435-f632-4446-9dd0-9e01a94f57dd",
    tenantId: "beecc5c3-e638-4d18-a389-94f85a2160e7",
    redirectUri: window.location.origin + window.location.pathname,
    scopes: ["Files.ReadWrite.All", "Sites.ReadWrite.All"],
  },
  sharepoint: {
    siteId: "roserockenv.sharepoint.com,c2d64daf-8711-41ec-8df9-41ed42322216,1ea6c7b0-6a71-45b6-8cc4-d1c446eb92f2",
    driveId: "b!r03WwhGH7EGN-UHtQjIiFrDHph5xarZFjMTRxEbrkvLYo35fKdIhTao0925TSetm",
    fileId: "01K75ZY52OJVHEWRLP3JG26L5DHRVOP3LK",
    worksheet: "OK 2026",
  },
  col: {
    jobNumber: 0,      // A
    client: 1,         // B
    siteAddress: 3,    // D
    jobDescription: 5, // F
    billAmount: 8,     // I
    dateCompleted: 9,  // J
    po: 10,            // K
    readyToInvoice: 17,// R — "Yes" = show in dashboard
    invoiceNumber: 18, // S — DocNumber written after invoice created
  },
  webhookUrl: "https://hook.us2.make.com/y2ljjye6hdup639respi7ne5brombh4j",
  refreshMs: 5 * 60 * 1000,
  qboItems: [
    "Transportation & Disposal",
    "Disposal",
    "Disposal (liquid material)",
    "Disposal (solid material)",
    "Delivery & Set Up",
    "Administrative",
    "Analyticals",
    "Annual Inspection",
    "Emergency Spill Response Trailer",
    "Remediation",
    "Confined Space Supervisor",
  ],
};

// ============================================================
// STATE
// ============================================================
let msalInstance = null;
let accessToken = null;
let allJobs = [];
let selectedIds = new Set();
let currentFilter = "Ready";
let prevReadyIds = new Set();
let refreshTimer = null;
let jobProductService = {};
let jobErrors = {}; // id -> last error message

// ============================================================
// MSAL AUTH (redirect flow)
// ============================================================
function initMsal() {
  msalInstance = new msal.PublicClientApplication({
    auth: {
      clientId: CONFIG.auth.clientId,
      authority: `https://login.microsoftonline.com/${CONFIG.auth.tenantId}`,
      redirectUri: CONFIG.auth.redirectUri,
    },
    cache: { cacheLocation: "sessionStorage", storeAuthStateInCookie: false },
  });
}

async function signIn() {
  try {
    document.getElementById("auth-error").style.display = "none";
    await msalInstance.loginRedirect({ scopes: CONFIG.auth.scopes });
  } catch (err) {
    const el = document.getElementById("auth-error");
    el.textContent = "Sign-in failed: " + (err.message || err);
    el.style.display = "block";
  }
}

async function getToken() {
  const accounts = msalInstance.getAllAccounts();
  if (accounts.length === 0) throw new Error("No accounts found");
  try {
    const resp = await msalInstance.acquireTokenSilent({
      scopes: CONFIG.auth.scopes, account: accounts[0],
    });
    accessToken = resp.accessToken;
    return accessToken;
  } catch (err) {
    await msalInstance.acquireTokenRedirect({ scopes: CONFIG.auth.scopes });
  }
}

function showApp(account) {
  document.getElementById("auth-overlay").classList.add("hidden");
  document.getElementById("app").style.display = "block";
  document.getElementById("user-info").textContent = account.username;
  refreshData();
  refreshTimer = setInterval(refreshData, CONFIG.refreshMs);
}

async function checkExistingSession() {
  initMsal();
  try {
    const resp = await msalInstance.handleRedirectPromise();
    if (resp) {
      accessToken = resp.accessToken;
      showApp(resp.account);
      return;
    }
  } catch (e) {
    if (e.errorCode === "interaction_in_progress") {
      sessionStorage.clear();
      window.location.reload();
      return;
    }
  }
  const accounts = msalInstance.getAllAccounts();
  if (accounts.length > 0) {
    try {
      await getToken();
      showApp(accounts[0]);
    } catch (e) {}
  }
}

// ============================================================
// GRAPH API HELPERS
// ============================================================
function wsUrl(path) {
  const { siteId, driveId, fileId, worksheet } = CONFIG.sharepoint;
  return `https://graph.microsoft.com/v1.0/sites/${siteId}/drives/${driveId}/items/${fileId}/workbook/worksheets('${encodeURIComponent(worksheet)}')/${path}`;
}

async function graphGet(url) {
  await getToken();
  const r = await fetch(url, { headers: { Authorization: `Bearer ${accessToken}` } });
  if (!r.ok) throw new Error(`Graph GET ${r.status}: ${await r.text()}`);
  return r.json();
}

async function graphPatch(url, body) {
  await getToken();
  const r = await fetch(url, {
    method: "PATCH",
    headers: { Authorization: `Bearer ${accessToken}`, "Content-Type": "application/json" },
    body: JSON.stringify(body),
  });
  if (!r.ok) throw new Error(`Graph PATCH ${r.status}: ${await r.text()}`);
  return r.json();
}

// ============================================================
// READ SPREADSHEET
// ============================================================
function parseJobs(rows) {
  if (!rows || rows.length < 2) return [];
  const c = CONFIG.col;
  const jobs = [];

  for (let i = 1; i < rows.length; i++) {
    const row = rows[i];
    if (!row || !row[c.jobNumber]) continue;

    const readyVal = String(row[c.readyToInvoice] || "").trim().toLowerCase();
    if (readyVal !== "yes") continue;

    const invoiceNum = row[c.invoiceNumber] ? String(row[c.invoiceNumber]).trim() : "";
    const status = invoiceNum ? "Invoiced" : "Ready";

    const billRaw = row[c.billAmount];
    const billAmount = typeof billRaw === "number" ? billRaw : parseFloat(String(billRaw).replace(/[,$]/g, "")) || 0;

    let dateCompleted = row[c.dateCompleted];
    if (typeof dateCompleted === "number") {
      dateCompleted = new Date(Math.floor(dateCompleted - 25569) * 86400 * 1000);
    }

    jobs.push({
      id: `row-${i}`,
      row: i + 1,
      jobNumber: String(row[c.jobNumber] || ""),
      client: String(row[c.client] || ""),
      siteAddress: String(row[c.siteAddress] || ""),
      jobDescription: String(row[c.jobDescription] || ""),
      billAmount,
      dateCompleted,
      po: String(row[c.po] || ""),
      status,
      invoiceNumber: invoiceNum,
      productService: jobProductService[`row-${i}`] || "",
      lastError: jobErrors[`row-${i}`] || "",
    });
  }
  return jobs;
}

// ============================================================
// REFRESH
// ============================================================
async function refreshData() {
  showStatus("loading", "⟳ Reading spreadsheet...");
  try {
    const data = await graphGet(wsUrl("usedRange?$select=values"));
    allJobs = parseJobs(data.values);

    const currentReadyIds = new Set(allJobs.filter(j => j.status === "Ready").map(j => j.id));
    let newCount = 0;
    if (prevReadyIds.size > 0) {
      currentReadyIds.forEach(id => { if (!prevReadyIds.has(id)) newCount++; });
    }
    if (newCount > 0) {
      document.getElementById("new-badge").textContent = `${newCount} new job${newCount > 1 ? "s" : ""} ready`;
      document.getElementById("new-badge").style.display = "inline-block";
      document.title = `(${newCount}) New Jobs Ready — Rose Rock`;
      playSound();
    }
    prevReadyIds = currentReadyIds;

    document.getElementById("last-update").textContent = `Updated ${new Date().toLocaleTimeString()}`;
    selectedIds = new Set();
    render();
    hideStatus();
  } catch (err) {
    showStatus("error", "✗ " + err.message);
    console.error("Refresh error:", err);
  }
}

// ============================================================
// CREATE INVOICES — send data to Make, get DocNumber, write to col S
// ============================================================
let isProcessing = false;
async function handleCreateInvoices() {
  if (isProcessing) return;
  isProcessing = true;
  try { await _handleCreateInvoices(); } finally { isProcessing = false; }
}
async function _handleCreateInvoices() {
  const selected = allJobs.filter(j => selectedIds.has(j.id) && j.status === "Ready");

  const missing = selected.filter(j => !j.productService);
  if (missing.length > 0) {
    showStatus("error", `✗ ${missing.length} job(s) need a Product/Service selected`);
    setTimeout(hideStatus, 5000);
    return;
  }

  showStatus("loading", `⟳ Scanning for latest invoice number...`);
  const sentRows = selected.map(j => j.row);

  // Get the next DocNumber sequence - scan column S for highest existing DocNumber
  let lastSeq = 0;
  const token = await getToken();
  try {
    const url = `${CONFIG.graphBase}/workbook/worksheets('${CONFIG.worksheetName}')/range(address='S1:S1000')`;
    const resp = await fetch(url, { headers: { Authorization: `Bearer ${token}` } });
    const data = await resp.json();
    if (data.values) {
      for (const row of data.values) {
        const val = row[0];
        if (val && typeof val === "string" && /^\d{4}-\d{4}$/.test(val)) {
          const seq = parseInt(val.split("-")[1]) || 0;
          if (seq > lastSeq) lastSeq = seq;
        }
      }
    }
  } catch(e) { console.error("Error reading DocNumbers:", e); }

  // Also check QBO for highest DocNumber via the existing tool
  // For safety, if column S had no results, use a known minimum
  if (lastSeq === 0) lastSeq = 377; // Safety fallback

  let jobIndex = 0;
  for (const job of selected) {
    jobIndex++;
    if (jobIndex > 1) {
      // Wait 20s between jobs to prevent DocNumber race conditions
      showStatus("loading", `⟳ Waiting for job ${jobIndex - 1} to complete before sending ${jobIndex} of ${selected.length}...`);
      await new Promise(r => setTimeout(r, 20000));
    }
    showStatus("loading", `⟳ Sending job ${jobIndex} of ${selected.length}: ${job.jobNumber}...`);
    let serviceDate = "";
    if (job.dateCompleted instanceof Date && !isNaN(job.dateCompleted)) {
      serviceDate = job.dateCompleted.toISOString().split("T")[0];
    }
    // Compute DocNumber: YYMM-XXXX
    const now = new Date();
    const yy = String(now.getFullYear()).substring(2);
    const mm = String(now.getMonth() + 1).padStart(2, "0");
    lastSeq++;
    const docNumber = yy + mm + "-" + String(lastSeq).padStart(4, "0");

    try {
      const params = new URLSearchParams({
        client: job.client,
        jobNumber: job.jobNumber,
        description: job.jobDescription,
        siteAddress: job.siteAddress,
        billAmount: String(job.billAmount),
        serviceDate: serviceDate,
        productService: job.productService,
        po: job.po,
        excelRow: String(job.row),
        docNumber: docNumber,
      });
      await fetch(CONFIG.webhookUrl, {
        method: "POST",
        mode: "no-cors",
        headers: { "Content-Type": "application/x-www-form-urlencoded" },
        body: params.toString(),
      });
    } catch (e) { console.error("Send error:", e); }
  }

  selectedIds = new Set();
  render();
  showStatus("loading", `⟳ ${selected.length} job(s) sent. Checking results in 20s...`);

  // Poll spreadsheet for results
  setTimeout(async () => {
    showStatus("loading", "⟳ Checking for results...");
    await refreshData();

    let created = 0, failed = 0;
    for (const row of sentRows) {
      const updated = allJobs.find(j => j.row === row);
      if (updated && updated.status === "Invoiced") {
        created++;
      } else {
        failed++;
        // Mark error in dashboard state
        if (updated) {
          updated.lastError = "Failed — check QBO for missing project or item";
          jobErrors[updated.id] = updated.lastError;
        }
      }
    }

    render();
    if (failed > 0 && created > 0) {
      showStatus("error", `✓ ${created} created, ✗ ${failed} failed — see Result column`);
    } else if (failed > 0) {
      showStatus("error", `✗ ${failed} failed — check QBO for missing project or item`);
    } else if (created > 0) {
      showStatus("success", `✓ ${created} invoice(s) created successfully`);
    } else {
      showStatus("loading", "⟳ Still processing — click Refresh to check again");
    }
    setTimeout(hideStatus, 10000);
  }, 15000);
}

// ============================================================
// RENDERING
// ============================================================
function render() { renderTabs(); renderTable(); renderSummary(); }

function getFiltered() {
  if (currentFilter === "All") return allJobs;
  return allJobs.filter(j => j.status === currentFilter);
}

function renderTabs() {
  const counts = {
    Ready: allJobs.filter(j => j.status === "Ready").length,
    Invoiced: allJobs.filter(j => j.status === "Invoiced").length,
    All: allJobs.length,
  };
  document.getElementById("tabs").innerHTML = ["Ready", "Invoiced", "All"].map(f =>
    `<button class="tab-btn ${currentFilter === f ? 'active' : ''}" onclick="switchTab('${f}')">
      ${f}<span class="tab-count">${counts[f]}</span>
    </button>`
  ).join("");

  let html = "";
  if (currentFilter === "Ready" && selectedIds.size > 0) {
    html = `<button class="btn-create" onclick="handleCreateInvoices()">Create Invoices (${selectedIds.size})</button>`;
  }
  document.getElementById("actions").innerHTML = html;
}

function renderTable() {
  const filtered = getFiltered();

  let head = `<tr style="border-bottom:1px solid #e5e7eb">
    <th style="width:40px"><input type="checkbox" onchange="toggleSelectAll()" ${selectedIds.size === filtered.length && filtered.length > 0 ? 'checked' : ''}></th>
    <th>Job #</th><th>Client</th><th>Site Address</th><th>Description</th>
    <th class="right">Amount</th><th>Completed</th><th>PO#</th><th>Status</th>`;
  if (currentFilter !== "Ready") head += `<th>Invoice # / Status</th>`;
  if (currentFilter === "Ready") head += `<th>Product/Service</th><th>Result</th>`;
  head += `</tr>`;
  document.getElementById("table-head").innerHTML = head;

  if (filtered.length === 0) {
    document.getElementById("table-body").innerHTML = `<tr class="empty-row"><td colspan="11">No ${currentFilter.toLowerCase()} jobs</td></tr>`;
    return;
  }

  let body = "";
  for (const job of filtered) {
    const sel = selectedIds.has(job.id);
    const bc = job.status === "Ready" ? "badge-ready" : "badge-invoiced";
    const ps = job.productService || "";

    body += `<tr class="data-row ${sel ? 'selected' : ''}" onclick="toggleSelect('${job.id}')">
      <td style="width:40px"><input type="checkbox" ${sel ? 'checked' : ''} onclick="event.stopPropagation(); toggleSelect('${job.id}')"></td>
      <td class="cell-job">${esc(job.jobNumber)}</td>
      <td class="cell-client">${esc(job.client)}</td>
      <td class="cell-address" title="${esc(job.siteAddress)}">${esc(job.siteAddress)}</td>
      <td class="cell-desc" title="${esc(job.jobDescription)}">${esc(job.jobDescription)}</td>
      <td class="cell-amount">${fmtCur(job.billAmount)}</td>
      <td class="cell-date">${fmtDate(job.dateCompleted)}</td>
      <td class="cell-po">${esc(job.po) || "—"}</td>
      <td><span class="badge ${bc}">${esc(job.status)}</span></td>`;

    if (currentFilter !== "Ready") {
      body += `<td class="cell-invoice">${esc(job.invoiceNumber) || "—"}</td>`;
    }
    if (currentFilter === "Ready") {
      const errMsg = job.lastError || "";
      body += `<td><select class="cell-select ${ps ? '' : 'empty'}" onclick="event.stopPropagation()" onchange="setPS('${job.id}', this.value)">
        <option value="">Select...</option>
        ${CONFIG.qboItems.map(item => `<option value="${esc(item)}" ${ps === item ? 'selected' : ''}>${esc(item)}</option>`).join("")}
      </select></td>`;
      body += `<td>${errMsg ? '<span style="color:#dc2626;cursor:help" title="' + esc(errMsg) + '">✗ Error</span>' : ''}</td>`;
    }
    body += `</tr>`;
  }
  document.getElementById("table-body").innerHTML = body;
}

function renderSummary() {
  const filtered = getFiltered();
  const total = filtered.reduce((s, j) => s + (j.billAmount || 0), 0);
  let left = `${filtered.length} job${filtered.length !== 1 ? "s" : ""} shown`;
  if (selectedIds.size > 0) left += ` · <span class="sel-count">${selectedIds.size} selected</span>`;
  document.getElementById("summary-left").innerHTML = left;
  document.getElementById("summary-right").innerHTML =
    `Total: <span class="total">${fmtCur(total)}</span>` +
    ` <span style="color:#e5e7eb;margin:0 8px">|</span> ` +
    `Auto-refresh: <span class="auto-refresh">ON</span> (5 min)`;
}

// ============================================================
// INTERACTIONS
// ============================================================
function toggleSelect(id) {
  selectedIds.has(id) ? selectedIds.delete(id) : selectedIds.add(id);
  render();
}

function toggleSelectAll() {
  const filtered = getFiltered();
  selectedIds = selectedIds.size === filtered.length ? new Set() : new Set(filtered.map(j => j.id));
  render();
}

function switchTab(tab) {
  currentFilter = tab;
  selectedIds = new Set();
  document.title = "Rose Rock — Invoice Dashboard";
  document.getElementById("new-badge").style.display = "none";
  render();
}

function setPS(jobId, value) {
  jobProductService[jobId] = value;
  const job = allJobs.find(j => j.id === jobId);
  if (job) job.productService = value;
}

// ============================================================
// UTILITIES
// ============================================================
function fmtCur(v) {
  if (v == null || v === "") return "—";
  const n = typeof v === "number" ? v : parseFloat(v);
  return isNaN(n) ? "—" : "$" + n.toLocaleString("en-US", { minimumFractionDigits: 2, maximumFractionDigits: 2 });
}

function fmtDate(d) {
  if (!d) return "—";
  if (d instanceof Date && !isNaN(d)) return d.toLocaleDateString("en-US", { month: "short", day: "numeric", year: "numeric" });
  return String(d);
}

function esc(s) {
  if (!s) return "";
  const d = document.createElement("div");
  d.textContent = String(s);
  return d.innerHTML;
}

function showStatus(type, msg) {
  const el = document.getElementById("status-bar");
  el.className = type;
  el.textContent = msg;
}

function hideStatus() {
  const el = document.getElementById("status-bar");
  el.className = "";
  el.style.display = "none";
}

function playSound() {
  try {
    const ctx = new (window.AudioContext || window.webkitAudioContext)();
    const osc = ctx.createOscillator();
    const gain = ctx.createGain();
    osc.connect(gain); gain.connect(ctx.destination);
    osc.frequency.setValueAtTime(587, ctx.currentTime);
    osc.frequency.setValueAtTime(784, ctx.currentTime + 0.15);
    osc.frequency.setValueAtTime(880, ctx.currentTime + 0.3);
    gain.gain.setValueAtTime(0.15, ctx.currentTime);
    gain.gain.exponentialRampToValueAtTime(0.01, ctx.currentTime + 0.5);
    osc.start(ctx.currentTime); osc.stop(ctx.currentTime + 0.5);
  } catch (e) {}
}

// ============================================================
// INIT
// ============================================================
window.addEventListener("DOMContentLoaded", checkExistingSession);
window.addEventListener("focus", () => {
  document.title = "Rose Rock — Invoice Dashboard";
  document.getElementById("new-badge").style.display = "none";
});
</script>
</body>
</html>
